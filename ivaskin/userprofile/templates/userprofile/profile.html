<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display+SC:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&display=swap" rel="stylesheet">
    <script src="{% static 'js/profile.js' %}"></script>
    <title>{{title}}</title>
</head>
<body>
    <header>
        <div class="header">
            <div class="header-inner">
                <div class="menu">
                    <h3><a class="logo" href="{% url 'index' %}">IVA SKIN</a></h3>
                    <h3><a class="menu__list-link" href="#">УСЛУГИ</a></h3>
                    <h3><a class="menu__list-link" href="#">О НАС</a></h3>
                    <h3><a class="menu__list-link" href="#">FAQ</a></h3>
                    <h3><a class="menu__list-link" href="#">КОНТАКТЫ</a></h3>
                </div>
                <div class="menu2">
                    <h3><a class="menu__list-link1" href="#" class="IVA" >Г. ТАГАНРОГ, УЛ. ОКТЯБРЬСКАЯ 17</a></h3>
                </div>
            </div>
        </div>
    </header>
    <div class="container-profile">
        <h1 id="h1-p">Добавте данные о себе, чтобы было проще записываться на процедуры</h1>
        {% if messages %}
            {% for message in messages %}
                    {{ message }}
            {% endfor %}
        {% endif %}
        
        <div class="profile-info" >
            <h3 id="h1-p">Информация о пользователе:</h3>
            <hr class="h-profile">
            <div class="user-details">
                
                <p><strong>Имя пользователя:</strong></p>
                <p>{{ profile.user.username }}</p>
                <p><strong>Имя:</strong></p>
                <p>{{ profile.first_name|default:"Не указано" }}</p>
                <p><strong>Фамилия:</strong></p>
                <p> {{ profile.last_name|default:"Не указано" }}</p>
                <p><strong>Телефон:</strong></p>
                <p>{{ profile.phone|default:"Не указан" }}</p>
                <p><strong>Email:</strong></p>
                <p>{{ profile.email|default:"Не указан" }}</p>
                <p><strong>Дата создания профиля:</strong></p>
                <p>{{ profile.created_at|date:"d.m.Y H:i" }}</p>
                <p><strong>Последнее обновление:</strong></p>
                <p>{{ profile.updated_at|date:"d.m.Y H:i" }}</p>
            </div>
        </div>
        <hr class="h-profile">
        <div class="change-for-profile-url">
            
            <form action="{% url 'userprofile:edit_profile' %}">
                <button class="btn-profile">Добавить ифнормацию в профлиль</button>
            </form>
            <form action="{% url 'userprofile:change_password' %}">
                <button class="btn-profile">Сменить пароль</button>
            </form>
            <form action="{% url 'logoutuser' %}" method="post">
                {% csrf_token %}
                <button class="btn-profile">Выйти</button>
            </form>
        </div>
        <hr class="h-profile">
        
        <!-- История записей -->
        <div>
            <h1 id="h1-p">Мои записи (всего: {{ total_appointments }})</h3>
            
            <!-- Активные записи -->
            {% if active_appointments %}
                <h1 id="h1-p">Активные записи:</h4>
                {% for appointment in active_appointments %}
                    <div class="user-details">
                        <p><strong>Услуга:</strong> {{ appointment.service }}</p>
                        <p><strong>Дата:</strong> {{ appointment.date|date:"d.m.Y" }}</p>
                        <p><strong>Время:</strong> {{ appointment.time|time:"H:i" }}</p>
                        <p><strong>Статус:</strong> {{ appointment.get_status_display }}</p>
                        {% if appointment.status == 'rescheduled' %}
                            <p><strong>Перенесена:</strong> {{ appointment.updated_at|date:"d.m.Y H:i" }}</p>
                        {% endif %}
                        <div class="btn-profile-wrap">
                            {% if appointment.can_be_cancelled %}
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="appointment_id" value="{{ appointment.id }}">
                                    <button type="submit" name="cancel_appointment" class="btn-profile2">Отменить</button>
                                </form>
                            {% endif %}
                            
                            {% if appointment.can_be_rescheduled %}
                                <button onclick="showRescheduleForm({{ appointment.id }})" class="btn-profile2">Перенести</button>
                            {% endif %}
                        </div>
                    </div>
                    <div id="rescheduleModal" style="display: none;">
                    <div>
                        <h3 id="h1-p">Перенести запись</h3>
                        <form method="post" id="rescheduleForm">
                            {% csrf_token %}
                            <input type="hidden" name="appointment_id" id="reschedule_appointment_id">
                            <p id="h1r">Новая дата:</p>
                            <input type="date" name="new_date" id="new_date" required onchange="updateAvailableTimes()">
                            <p id="h1r">Доступное время:</p>
                            <select name="new_time" id="new_time" required>
                                <option value="">Выберите время</option>
                            </select>
                            <button type="submit" name="reschedule_appointment" class="btn-profile2">Перенести</button>
                            <button type="button" onclick="hideRescheduleForm()" class="btn-profile2">Отмена</button>
                        </form>
                    </div>
            </div>
                {% endfor %}
            {% else %}
                <p id="h1r">У вас нет активных записей</p>
            {% endif %}
            <!-- Форма для переноса записи (скрытая) -->
            
            <h4 id="h1-p">Завершенные записи:</h4>
            <!-- Завершенные записи -->
            <div class="user-details">
                {% if completed_appointments %}
                    
                    {% for appointment in completed_appointments %}
                        <div>
                            <p><strong>Услуга:</strong> {{ appointment.service }}</p>
                            <p><strong>Дата:</strong> {{ appointment.date|date:"d.m.Y" }}</p>
                            <p><strong>Время:</strong> {{ appointment.time|time:"H:i" }}</p>
                            <p><strong>Статус:</strong> {{ appointment.get_status_display }}</p>
                            {% if appointment.cancelled_at %}
                                <p><strong>Отменена:</strong> {{ appointment.cancelled_at|date:"d.m.Y H:i" }}</p>
                            {% endif %}
                        </div>
                        <hr class="h-profile">
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        
        
    </div>
    
</body>
</html>